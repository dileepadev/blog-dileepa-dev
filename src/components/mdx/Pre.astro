---
const props = Astro.props;
---

<div class="relative group cursor-default code-block-wrapper">
  <pre
    {...props}
    class={`rounded-lg ${props.class || ""} cursor-text group-hover:cursor-copy`}><slot /></pre>

  <button
    class="copy-btn cursor-pointer absolute top-3 right-3 p-1.5 rounded-md bg-white/10 text-white/70 opacity-0 group-hover:opacity-100 transition-all duration-200 hover:bg-white/20 hover:text-white focus:opacity-100"
    aria-label="Copy code"
    title="Copy code"
  >
    <!-- Copy Icon -->
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="16"
      height="16"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="copy-icon"
    >
      <rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>
      <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
    </svg>
    <!-- Check Icon (Hidden by default) -->
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="16"
      height="16"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="check-icon hidden text-green-400"
    >
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
  </button>
</div>

<script>
  // Use a class based selection to handle multiple instances and View Transitions if added later
  function setupCopyButtons() {
    document.querySelectorAll(".code-block-wrapper").forEach((wrapper) => {
      const button = wrapper.querySelector(".copy-btn");
      const pre = wrapper.querySelector("pre");
      const copyIcon = button?.querySelector(".copy-icon");
      const checkIcon = button?.querySelector(".check-icon");

      if (button && pre) {
        button.addEventListener("click", async () => {
          const code = pre.innerText;

          try {
            await navigator.clipboard.writeText(code);

            // Show check icon
            copyIcon?.classList.add("hidden");
            checkIcon?.classList.remove("hidden");

            // Revert after 2 seconds
            setTimeout(() => {
              copyIcon?.classList.remove("hidden");
              checkIcon?.classList.add("hidden");
            }, 2000);
          } catch (err) {
            console.error("Failed to copy text: ", err);
          }
        });
      }
    });
  }

  // Run on initial load
  setupCopyButtons();

  // Support Astro View Transitions if enabled
  document.addEventListener("astro:page-load", setupCopyButtons);
</script>
