---
import Layout from "../layouts/Layout.astro";

/** @type {Record<string, any>} */
const modules = import.meta.glob("../content/posts/**/*.mdx", { eager: true });

const posts = Object.entries(modules)
  .map(([path, mod]) => {
    const m = mod as any;
    const slug =
      path
        .split("/")
        .pop()
        ?.replace(/\.mdx$/, "") ?? "";
    return {
      slug,
      ...(m.frontmatter || {}),
    };
  })
  .sort(
    (a, b) => new Date(b.pubDate).getTime() - new Date(a.pubDate).getTime(),
  );

function formatDate(date: string) {
  return new Date(date).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}
---

<Layout
  title="Blog - Dileepa Bandara"
  description="Read my latest articles on software engineering, AI, and cloud computing."
>
  <div class="max-w-7xl mx-auto space-y-8">
    <h1 class="text-4xl font-bold text-text-primary mb-8 animate-fade-in">
      Blog Posts
    </h1>

    <!-- Search & Sort controls -->
    <div class="mb-6 max-w-4xl">
      <div
        class="grid grid-cols-1 gap-4 sm:grid-cols-[1fr_auto] sm:items-start"
      >
        <div class="flex flex-col gap-2">
          <label
            for="blog-search"
            class="block text-sm font-semibold text-text-primary">Search</label
          >
          <div class="relative">
            <svg
              aria-hidden="true"
              class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-text-secondary pointer-events-none"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z"
              ></path>
            </svg>

            <input
              id="blog-search"
              type="search"
              placeholder="Search posts by date, title, description, or tags..."
              class="w-full p-3 pl-10 pr-4 rounded-md border border-border-light bg-bg-default text-text-primary placeholder:text-text-secondary"
              aria-describedby="search-help"
            />
          </div>

          <p id="search-help" class="mt-2 text-sm text-text-secondary">
            Try "AI", "cloud", or a tag like "tutorial".
          </p>
        </div>

        <div class="w-full sm:w-auto sm:justify-self-end sm:h-full">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:h-full">
            <div class="sm:flex sm:flex-col sm:h-full">
              <label
                for="blog-sort"
                class="block text-sm font-semibold text-text-primary mb-2"
                >Sort</label
              >
              <select
                id="blog-sort"
                class="w-full p-3 pl-3 pr-10 rounded-md border border-border-light bg-bg-default text-text-primary appearance-none"
              >
                <option value="newest">Newest</option>
                <option value="oldest">Oldest</option>
                <option value="title-asc">Title A-Z</option>
                <option value="title-desc">Title Z-A</option>
              </select>
            </div>

            <div class="view-toggle sm:flex sm:flex-col sm:h-full">
              <label class="block text-sm font-semibold text-text-primary mb-4">View</label>
              <div class="flex gap-2">
                <button type="button" data-view="grid" aria-pressed="false" class="p-2 rounded-md border border-border-light bg-bg-default text-text-primary" title="Card view" aria-label="Card view">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <path d="M7 7h10"/>
                    <path d="M7 11h10"/>
                    <path d="M7 15h6"/>
                  </svg>
                </button>
                <button type="button" data-view="list" aria-pressed="false" class="p-2 rounded-md border border-border-light bg-bg-default text-text-primary" title="Table view" aria-label="Table view">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <rect x="3" y="4" width="18" height="16" rx="1" />
                    <path d="M3 9h18" />
                    <path d="M9 4v16" />
                    <path d="M15 4v16" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {
      posts.length === 0 ? (
        <div class="py-12">
          <p class="text-lg text-text-secondary mb-4">Coming soon...</p>
          <p class="text-text-tertiary">
            I'm working on some exciting articles. Stay tuned!
          </p>
        </div>
      ) : (
        <div>
          <div id="no-results" class="hidden py-12 text-text-secondary">
            No posts match your search.
          </div>
          <div id="posts-grid" class="grid gap-6">
            {posts.map((post) => {
              const searchable =
                `${post.title} ${post.description || ""} ${post.tags ? post.tags.join(" ") : ""} ${post.pubDate || ""} ${post.pubDate ? formatDate(post.pubDate) : ""}`.toLowerCase();
              return (
                <a
                  href={`/blog/${post.slug}`}
                  class="post-item block p-6 bg-bg-elevated border border-border-light rounded-xl hover:shadow-lg hover:border-accent-blue/30 hover:scale-[1.01] transition-all duration-300 group"
                  data-searchable={searchable}
                  data-pubdate={post.pubDate || ""}
                  data-title={post.title || ""}
                >
                  {post.banner && (
                    <img
                      src={post.banner}
                      alt={post.bannerAlt || post.title}
                      class="w-full h-44 object-cover rounded-md mb-4"
                    />
                  )}

                  {post.pubDate && (
                    <p class="text-sm text-text-muted mb-2 font-medium">
                      {formatDate(post.pubDate)}
                    </p>
                  )}

                  <h3 class="text-2xl font-semibold text-text-primary group-hover:text-accent-blue transition-colors">
                    {post.title}
                  </h3>

                  {post.description && (
                    <p class="mt-3 text-text-secondary leading-relaxed">
                      {post.description}
                    </p>
                  )}

                  {post.tags && (
                    <div class="mt-3 flex gap-2 flex-wrap">
                      {post.tags.map((tag: string) => (
                        <span class="capitalize rounded-md bg-bg-secondary border border-border-light text-text-secondary px-2.5 py-0.5 text-sm font-medium">
                          {tag}
                        </span>
                      ))}
                    </div>
                  )}
                </a>
              );
            })}
          </div>

          <!-- Table view for list mode (hidden by default) -->
          <table id="posts-table" class="hidden w-full text-sm table-fixed border-collapse mt-2">
            <thead>
              <tr class="text-text-primary text-left">
                <th class="p-3 w-36">Date</th>
                <th class="p-3">Title</th>
                <th class="p-3 hidden sm:table-cell">Description</th>
                <th class="p-3 w-36 hidden sm:table-cell">Tags</th>
              </tr>
            </thead>
            <tbody>
              {posts.map((post) => {
                const searchable =
                  `${post.title} ${post.description || ""} ${post.tags ? post.tags.join(" ") : ""} ${post.pubDate || ""} ${post.pubDate ? formatDate(post.pubDate) : ""}`.toLowerCase();
                return (
                  <tr class="post-row border-t border-border-light hover:bg-bg-elevated hover:opacity-95 transition cursor-pointer" data-searchable={searchable} data-pubdate={post.pubDate || ""} data-title={post.title || ""} data-slug={post.slug} tabindex="0">
                    <td class="p-3 text-text-muted">{post.pubDate ? formatDate(post.pubDate) : ''}</td>
                    <td class="p-3 font-medium"><a href={`/blog/${post.slug}`} class="text-text-primary hover:text-accent-blue">{post.title}</a></td>
                    <td class="p-3 text-text-secondary truncate hidden sm:table-cell" style="max-width:45ch">{post.description || ''}</td>
                    <td class="p-3 text-text-secondary hidden sm:table-cell">{post.tags ? post.tags.join(', ') : ''}</td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )
    }
  </div>

  <script type="module">
    const input = document.getElementById("blog-search");
    const grid = document.getElementById("posts-grid");
    const table = document.getElementById("posts-table");
    const noResults = document.getElementById("no-results");

    function normalize(s) {
      return (s || "").toLowerCase();
    }

    function getActiveView() {
      return localStorage.getItem('blogViewMode') || new URLSearchParams(window.location.search).get('view') || 'grid';
    }

    function filterPosts(query) {
      const q = normalize(query).trim();
      let visible = 0;
      const view = getActiveView();

      if (view === 'grid') {
        const items = grid ? Array.from(grid.querySelectorAll('.post-item')) : [];
        for (const item of items) {
          const text = normalize(item.getAttribute('data-searchable'));
          const match = q === '' || text.includes(q);
          item.style.display = match ? '' : 'none';
          if (match) visible += 1;
        }
      } else {
        const rows = table ? Array.from(table.querySelectorAll('tbody tr')) : [];
        for (const row of rows) {
          const text = normalize(row.getAttribute('data-searchable'));
          const match = q === '' || text.includes(q);
          row.style.display = match ? '' : 'none';
          if (match) visible += 1;
        }
      }

      if (noResults) noResults.classList.toggle('hidden', visible > 0);
    }

    let timeout;
    input?.addEventListener("input", (e) => {
      clearTimeout(timeout);
      const q = e.target.value;
      timeout = setTimeout(() => filterPosts(q), 150);
    });

    // Allow clearing with Escape
    input?.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        input.value = "";
        filterPosts("");
      }
    });

    // Initialize
    // If a query param `q` is present, pre-fill the input and run the filter.
    const params = new URLSearchParams(window.location.search);
    const initialQuery = params.get("q") || "";

    // Sort control
    const sortSelect = document.getElementById("blog-sort");

    function sortPosts(criteria) {
      const view = getActiveView();

      if (view === 'grid') {
        if (!grid) return;
        const elements = Array.from(grid.querySelectorAll('.post-item'));
        const getDate = (el) => new Date(el.getAttribute('data-pubdate') || 0).getTime();
        const getTitle = (el) => (el.getAttribute('data-title') || '').toLowerCase();

        elements.sort((a, b) => {
          if (criteria === 'newest') return getDate(b) - getDate(a);
          if (criteria === 'oldest') return getDate(a) - getDate(b);
          if (criteria === 'title-asc') return getTitle(a).localeCompare(getTitle(b));
          if (criteria === 'title-desc') return getTitle(b).localeCompare(getTitle(a));
          return 0;
        });

        for (const el of elements) grid.appendChild(el);
      } else {
        if (!table) return;
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const getDate = (r) => new Date(r.getAttribute('data-pubdate') || 0).getTime();
        const getTitle = (r) => (r.getAttribute('data-title') || '').toLowerCase();

        rows.sort((a, b) => {
          if (criteria === 'newest') return getDate(b) - getDate(a);
          if (criteria === 'oldest') return getDate(a) - getDate(b);
          if (criteria === 'title-asc') return getTitle(a).localeCompare(getTitle(b));
          if (criteria === 'title-desc') return getTitle(b).localeCompare(getTitle(a));
          return 0;
        });

        for (const r of rows) tbody.appendChild(r);
      }
    }

    sortSelect?.addEventListener("change", (e) => {
      const val = e.target.value;
      sortPosts(val);
    });

    // View toggle logic: grid or list
    const viewToggleButtons = Array.from(document.querySelectorAll('.view-toggle button'));
    function setView(view) {
      const isList = view === 'list';

      // Show/hide grid and table
      if (isList) {
        if (grid) grid.classList.add('hidden');
        if (table) table.classList.remove('hidden');
      } else {
        if (grid) grid.classList.remove('hidden');
        if (table) table.classList.add('hidden');
      }

      // Update card appearances (if visible)
      const elements = Array.from(grid ? grid.querySelectorAll('.post-item') : []);
      for (const item of elements) {
        if (isList) {
          item.classList.add('flex', 'gap-2', 'items-center', 'p-2');
          item.classList.remove('p-6');
          const img = item.querySelector('img');
          if (img) {
            img.classList.remove('w-full', 'h-44', 'mb-4', 'rounded-md');
            img.classList.add('w-20', 'h-14', 'mb-0', 'mr-3', 'flex-shrink-0', 'rounded-sm');
          }
        } else {
          item.classList.remove('flex', 'gap-2', 'items-center', 'p-2');
          item.classList.add('p-6');
          const img = item.querySelector('img');
          if (img) {
            img.classList.add('w-full', 'h-44', 'mb-4', 'rounded-md');
            img.classList.remove('w-20', 'h-14', 'mb-0', 'mr-3', 'flex-shrink-0', 'rounded-sm');
          }
        }
      }

      // Update table rows sizing (if present)
      if (table) {
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        rows.forEach(r => {
          if (isList) {
            r.classList.add('p-2');
          } else {
            r.classList.remove('p-2');
          }
        });
      }

      viewToggleButtons.forEach(b => {
        const active = b.dataset.view === view;
        b.setAttribute('aria-pressed', active ? 'true' : 'false');
        b.classList.toggle('ring-2', active);
        b.classList.toggle('ring-accent-blue/30', active);
      });

      const cur = new URL(window.location);
      cur.searchParams.set('view', view);
      window.history.replaceState({}, '', cur);
      localStorage.setItem('blogViewMode', view);

      // Re-apply sort and filter when changing view to keep UI consistent
      const activeSort = sortSelect?.value || 'newest';
      sortPosts(activeSort);
      filterPosts(input?.value || '');

      // Re-attach row handlers in case table rows were re-ordered
      attachTableRowHandlers();
    }

    viewToggleButtons.forEach(btn => btn.addEventListener('click', () => setView(btn.dataset.view)));

    // Attach click handlers to table rows so they act like links
    function attachTableRowHandlers() {
      if (!table) return;
      const rows = Array.from(table.querySelectorAll('tbody tr'));
      for (const r of rows) {
        // prevent duplicate listener attachments
        if (r.dataset._clickAttached) continue;
        r.addEventListener('click', (e) => {
          // if an inner link was clicked, let it handle navigation
          if (e.target.closest('a')) return;
          const slug = r.getAttribute('data-slug');
          if (slug) window.location.href = `/blog/${slug}`;
        });
        r.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            const slug = r.getAttribute('data-slug');
            if (slug) window.location.href = `/blog/${slug}`;
          }
        });
        r.dataset._clickAttached = '1';
      }
    }

    const initialView = params.get('view') || localStorage.getItem('blogViewMode') || 'grid';
    setView(initialView);

    // Ensure rows are clickable from the start
    attachTableRowHandlers();

    const initialSort = params.get("sort") || "newest";
    if (sortSelect) sortSelect.value = initialSort;

    // Apply initial sort then the initial filter
    sortPosts(initialSort);

    if (initialQuery) {
      input.value = initialQuery;
      filterPosts(initialQuery);
    } else {
      filterPosts("");
    }

    // If the hash is #search, focus the search input for convenience.
    if (window.location.hash === "#search") {
      input?.focus();
    }
  </script>
</Layout>
